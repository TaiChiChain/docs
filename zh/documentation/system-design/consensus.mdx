---
title: "共识"
---

## 关键概念

共识算法是确保区块链网络中多个节点达成一致的机制。拜占庭容错（BFT）算法是区块链行业广泛采用的重要的共识算法之一，BFT类算法通过多轮投票或消息交换的方式达成共识，能够在少数节点故障或恶意情况下保证区块链系统的活性与安全性。

## dBFT

### dBFT概述

PBFT（Practical Byzantine Fault Tolerance）是一种基于BFT的共识算法，该算法使得交易能够得到快速、安全确认，在公链中被广泛应用。但是原生的PBFT存在主节点可预测、可扩展性较差等问题，AxiomLedger针对这些问题进行优化改进，实现了 **dBFT（Delegated Byzantine Fault Tolerant）** 算法。

### 基本流程

AxiomLedger 共识模块的交易流程如下：

    1. 交易池接收来自P2P与API 模块的已校验通过的交易；
    2. 交易池根据账户nonce进行排序，将其分类为就绪交易集与未就绪交易集，就绪交易集内的交易可被出块节点打包但暂未打包(类比以太坊交易池的处于pending队列的交易集合)，未就绪交易集内的交易暂时不可被出块节点打包（类比以太坊交易池的处于queue队列的交易集合，通常为高并发情况下暂存nonce较大的交易）；
    3. 当前任期的出块节点按照打包策略从交易池中的就绪交易集获取一定数量的交易集合组装成区块，并发起当前区块的共识提案；
    4. 节点共识网络中所有的验证节点参与区块提案多轮投票共识，最终该区块得到确认，推送给执行器进行交易执行。

<Warning color="yellow">
    为了性能考虑，验证节点/主节点在参与区块共识时不执行当前区块内的交易，共识完成后由执行器执行，执行后账本状态的一致性通过状态检查点机制来保证。
</Warning>

![共识模块架构图](/zh/images/system-design/consensus-architecture2.png)

### 状态检查点机制

执行器将区块内的交易执行完毕后，进行区块落盘，同时会通知共识模块当前区块的执行结果（包含状态树、回执根等信息的区块哈希、区块高度等）。当区块到达检查点时，验证节点将针对检查点的区块信息进行共识，以确保账本一致性（比如检查点间隔为10个区块，即每隔10个区块会进行一次账本状态确认）。在接收到足够一致的检查点信息后，验证节点方可继续进行区块共识。

此外，为了防止区块高度迟迟未到达检查点，验证节点也会设置超时机制，在超时器触发时，验证节点会主动针对最新的区块信息进行共识。

状态检查点机制确保了账本的最终一致性，验证节点无需在区块打包过程中针对每个区块的执行结果进行共识，有效提高了共识性能。

<Warning color="yellow">
    在AxiomLedger中，默认检查点间隔配置为1，即每个区块都需要检查网络中是否大多数验证者节点已经得到正确落盘。
</Warning>

## 纪元变更

### WRF算法

**WRF（Weighted Random Function）** 是一种用于根据权重值进行随机选择的算法。在节点加入网络时，将分配不同权重。将所有的节点权重映射到一个区间，然后，根据提供的随机数种子使用随机数生成器生成随机数，根据随机数所在的区间来选择节点。权重较高的节点在区间中占据较大比例，被选择的概率相应较高。

在AxiomLedger中，验证节点集合的选择与出块节点选择均通过WRF算法，但随机数种子的分配方式不同。

- **验证节点集合选择**：最新一个区块的区块哈希（检查点的上一个区块）、纪元合约所记录的当前纪元信息、当前已选择的验证节点数量。
- **出块节点选择**：上一个检查点的信息、纪元合约所记录的当前纪元信息、当前的任期号。

WRF算法的优点在于：

1. **灵活性与可定制性**：WRF算法可根据具体需求为每个节点分配不同的权重（比如按照质押比例、治理分配等方式），从而灵活地控制随机选择的概率分布。
2. **高效性**：由于随机数种子均是已共识通过的内容，无需针对随机种子进行新一轮共识，只涉及基本的数学计算；
3. **安全性**：由于随机数种子的确认需要等待检查点的上一个区块出块完成，因此无法提前预知随机数，也就无法确认验证节点集合。同理，由于出块节点从验证节点集合中选择，也就无法提前预知当前任期的出块节点。

### 主要流程

纪元变更通过内置的纪元管理合约完成，该合约包含了纪元号、纪元间隔、任期间隔等信息，纪元管理合约主要负责验证节点集合与候选节点集合的确认。纪元管理合约将存储每个纪元的验证节点集合与候选节点集合，其变更将通过WRF算法。

<Warning>
    每一轮WRF流程将选择一个验证节点，因此，WRF的轮次跟验证节点集合数量有关。
</Warning>

![纪元变更流程](/zh/images/system-design/epoch-change.png)

每一个任期间隔是一个状态检查点间隔，该任期内将分配一个出块节点，如果出块节点在任期内出现宕机等异常状态，将进行一次异常任期切换。需要注意的是，异常任期切换后的任期间隔将不是个状态检查点间隔，而是状态检查点间隔减去上一个异常任期间隔（如图，任期3+任期4=任期间隔）。